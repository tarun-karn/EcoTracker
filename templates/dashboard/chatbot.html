{% extends 'base.html' %}
{% load static %}

{% block title %}EcoBot AI Assistant - EcoTracker{% endblock %}

{% block extra_css %}
<link href="{% static 'css/custom.css' %}" rel="stylesheet">
<style>
/* ChatGPT-inspired Design */
.chatgpt-container {
    height: 100vh;
    background: #343541;
    display: flex;
    flex-direction: column;
}

.chat-header {
    background: #202123;
    border-bottom: 1px solid #4d4d4f;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    background: #343541;
}

.message-wrapper {
    border-bottom: 1px solid #4d4d4f;
    padding: 24px 0;
}

.message-content {
    max-width: 768px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    gap: 16px;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}

.user-avatar {
    background: #10a37f;
    color: white;
}

.bot-avatar {
    background: #19c37d;
    color: white;
}

.message-text {
    color: #ececf1;
    line-height: 1.6;
    flex: 1;
    padding-top: 4px;
}

.user-message .message-text {
    color: #ececf1;
}

.bot-message .message-text {
    color: #ececf1;
}

.chat-input-area {
    background: #343541;
    padding: 24px;
    border-top: 1px solid #4d4d4f;
}

.chat-input-container {
    max-width: 768px;
    margin: 0 auto;
    position: relative;
}

.chat-input {
    width: 100%;
    background: #40414f;
    border: 1px solid #565869;
    border-radius: 12px;
    padding: 16px 52px 16px 16px;
    color: #ececf1;
    font-size: 16px;
    line-height: 1.5;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
    min-height: 24px;
    max-height: 200px;
}

.chat-input:focus {
    border-color: #10a37f;
}

.chat-input::placeholder {
    color: #8e8ea0;
}

.send-button {
    position: absolute;
    right: 12px;
    bottom: 12px;
    width: 32px;
    height: 32px;
    background: #10a37f;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

.send-button:hover {
    background: #0d8f6f;
}

.send-button:disabled {
    background: #565869;
    cursor: not-allowed;
}

.typing-indicator {
    display: none;
}

.typing-indicator.show {
    display: block;
}

.typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 0;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: #8e8ea0;
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
    }
    30% {
        transform: translateY(-4px);
        opacity: 1;
    }
}

.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
    max-width: 768px;
    margin-left: auto;
    margin-right: auto;
    padding: 0 24px;
}

.quick-action {
    background: #40414f;
    border: 1px solid #565869;
    color: #ececf1;
    padding: 8px 12px;
    border-radius: 16px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.quick-action:hover {
    background: #565869;
    border-color: #8e8ea0;
}

.welcome-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    text-align: center;
}

.welcome-title {
    color: #ececf1;
    font-size: 32px;
    font-weight: 600;
    margin-bottom: 32px;
}

.welcome-examples {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    max-width: 800px;
    width: 100%;
}

.example-card {
    background: #40414f;
    border: 1px solid #565869;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
}

.example-card:hover {
    background: #4a4b5a;
    border-color: #8e8ea0;
}

.example-title {
    color: #ececf1;
    font-weight: 600;
    margin-bottom: 8px;
}

.example-text {
    color: #8e8ea0;
    font-size: 14px;
}

.scroll-to-bottom {
    position: fixed;
    bottom: 140px;
    right: 24px;
    width: 40px;
    height: 40px;
    background: #40414f;
    border: 1px solid #565869;
    border-radius: 50%;
    color: #ececf1;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.scroll-to-bottom:hover {
    background: #565869;
}

/* Custom scrollbar */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #40414f;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #565869;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #6b6c7b;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .message-content {
        padding: 0 16px;
    }
    
    .chat-input-area {
        padding: 16px;
    }
    
    .quick-actions {
        padding: 0 16px;
    }
    
    .welcome-examples {
        grid-template-columns: 1fr;
    }
}

/* Code blocks */
.message-text pre {
    background: #2f2f2f;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 12px;
    margin: 8px 0;
    overflow-x: auto;
}

.message-text code {
    background: #2f2f2f;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

/* Lists */
.message-text ul, .message-text ol {
    margin: 8px 0;
    padding-left: 20px;
}

.message-text li {
    margin: 4px 0;
}

/* Links */
.message-text a {
    color: #10a37f;
    text-decoration: underline;
}

.message-text a:hover {
    color: #0d8f6f;
}
</style>
{% endblock %}

{% block content %}
<div class="chatgpt-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-blue-500 rounded-lg flex items-center justify-center text-white font-bold">
                üå±
            </div>
            <div>
                <h1 class="text-xl font-semibold text-white">EcoBot AI Assistant</h1>
                <p class="text-sm text-gray-400">Powered by OpenRouter & DeepSeek</p>
            </div>
        </div>
        <div class="flex items-center gap-4 text-sm text-gray-400">
            <span>üèÜ {{ user_stats.total_points }} pts</span>
            <span>üåç {{ user_stats.total_carbon }}kg CO‚ÇÇ</span>
            <span>üëã {{ user_stats.username }}</span>
        </div>
    </div>

    <!-- Chat Messages -->
    <div id="chat-messages" class="chat-messages">
        <!-- Welcome Screen (shown when no messages) -->
        <div id="welcome-screen" class="welcome-screen">
            <h2 class="welcome-title">üå± EcoBot AI Assistant</h2>
            <p class="text-gray-400 mb-8">Hi {{ user_stats.username }}! I'm your personalized AI eco mentor. How can I help you today?</p>
            
            <div class="welcome-examples">
                <div class="example-card" onclick="sendMessage('What should I do to reduce my carbon footprint?')">
                    <div class="example-title">üéØ Get Recommendations</div>
                    <p class="example-text">"What should I do to reduce my carbon footprint?"</p>
                </div>
                <div class="example-card" onclick="sendMessage('How are my points and carbon savings?')">
                    <div class="example-title">üìà Check Progress</div>
                    <p class="example-text">"How are my points and carbon savings?"</p>
                </div>
                <div class="example-card" onclick="sendMessage('Create a new challenge for me')">
                    <div class="example-title">üéÆ Get Challenges</div>
                    <p class="example-text">"Create a new challenge for me"</p>
                </div>
                <div class="example-card" onclick="sendMessage('Predict my future carbon savings')">
                    <div class="example-title">üîÆ Future Insights</div>
                    <p class="example-text">"Predict my future carbon savings"</p>
                </div>
                <div class="example-card" onclick="sendMessage('Show my efficiency analysis')">
                    <div class="example-title">‚ö° Efficiency Tips</div>
                    <p class="example-text">"Show my efficiency analysis"</p>
                </div>
                <div class="example-card" onclick="sendMessage('Give me eco-friendly tips')">
                    <div class="example-title">üí° Eco Tips</div>
                    <p class="example-text">"Give me eco-friendly tips"</p>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="typing-indicator">
            <div class="message-wrapper">
                <div class="message-content">
                    <div class="message-avatar bot-avatar">ü§ñ</div>
                    <div class="message-text">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions" id="quick-actions" style="display: none;">
        <button class="quick-action" onclick="sendMessage('What should I do?')">What should I do?</button>
        <button class="quick-action" onclick="sendMessage('How are my points?')">My progress</button>
        <button class="quick-action" onclick="sendMessage('Give me a challenge')">New challenge</button>
        <button class="quick-action" onclick="sendMessage('Show predictions')">Predictions</button>
        <button class="quick-action" onclick="sendMessage('Efficiency tips')">Efficiency</button>
        <button class="quick-action" onclick="sendMessage('Eco tips')">Eco tips</button>
    </div>

    <!-- Chat Input -->
    <div class="chat-input-area">
        <div class="chat-input-container">
            <form id="chat-form">
                {% csrf_token %}
                <textarea 
                    id="chat-input" 
                    class="chat-input"
                    placeholder="Message EcoBot..."
                    rows="1"
                    autofocus
                ></textarea>
                <button type="submit" id="send-button" class="send-button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Scroll to bottom button -->
    <button id="scroll-to-bottom" class="scroll-to-bottom">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M7 13L12 18L17 13M12 6V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
</div>

<script>
const chatMessages = document.getElementById('chat-messages');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const sendButton = document.getElementById('send-button');
const typingIndicator = document.getElementById('typing-indicator');
const welcomeScreen = document.getElementById('welcome-screen');
const quickActions = document.getElementById('quick-actions');
const scrollToBottomBtn = document.getElementById('scroll-to-bottom');

let hasMessages = false;

// Auto-resize textarea
function autoResize() {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
}

chatInput.addEventListener('input', autoResize);

// Auto-scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Show/hide scroll to bottom button
function checkScrollPosition() {
    const isAtBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 100;
    scrollToBottomBtn.style.display = hasMessages && !isAtBottom ? 'flex' : 'none';
}

chatMessages.addEventListener('scroll', checkScrollPosition);
scrollToBottomBtn.addEventListener('click', scrollToBottom);

// Hide welcome screen and show quick actions
function showChatInterface() {
    if (!hasMessages) {
        welcomeScreen.style.display = 'none';
        quickActions.style.display = 'flex';
        hasMessages = true;
        checkScrollPosition();
    }
}

// Add message to chat
function addMessage(text, sender, additionalData = null) {
    showChatInterface();
    
    const messageWrapper = document.createElement('div');
    messageWrapper.className = 'message-wrapper';
    
    let avatar = 'ü§ñ';
    let bgClass = 'bot-avatar';
    
    if (sender === 'user') {
        avatar = 'üë§';
        bgClass = 'user-avatar';
    }
    
    // Process text for better formatting
    text = text.replace(/\n/g, '<br>');
    
    messageWrapper.innerHTML = `
        <div class="message-content">
            <div class="message-avatar ${bgClass}">${avatar}</div>
            <div class="message-text">
                ${text}
                ${additionalData ? handleAdditionalData(additionalData) : ''}
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageWrapper);
    scrollToBottom();
}

// Handle additional data from AI responses
function handleAdditionalData(data) {
    let additionalContent = '';
    
    if (data.recommendation) {
        const rec = data.recommendation;
        if (rec.metadata && rec.metadata.expected_points) {
            additionalContent += `<br><br><div style="background: #40414f; padding: 12px; border-radius: 8px; border-left: 4px solid #10a37f; margin-top: 8px;">
                <strong>üéØ Expected Impact:</strong> ${rec.metadata.expected_points} points | ${rec.metadata.expected_carbon}kg CO‚ÇÇ
            </div>`;
        }
    }
    
    if (data.current_challenge) {
        const challenge = data.current_challenge;
        additionalContent += `<br><br><div style="background: #40414f; padding: 12px; border-radius: 8px; border-left: 4px solid #10a37f; margin-top: 8px;">
            <strong>üéÆ Current Challenge:</strong> ${challenge.progress}% complete | ${challenge.reward} points reward
        </div>`;
    }
    
    if (data.predictions) {
        const pred = data.predictions;
        if (pred.predictions) {
            const total = pred.predictions.reduce((a, b) => a + b, 0);
            additionalContent += `<br><br><div style="background: #40414f; padding: 12px; border-radius: 8px; border-left: 4px solid #10a37f; margin-top: 8px;">
                <strong>üìä 30-Day Forecast:</strong> ${total.toFixed(1)}kg CO‚ÇÇ | ${(pred.confidence * 100).toFixed(0)}% confidence
            </div>`;
        }
    }
    
    if (data.insights) {
        const insights = data.insights;
        if (insights.efficiency_score) {
            additionalContent += `<br><br><div style="background: #40414f; padding: 12px; border-radius: 8px; border-left: 4px solid #10a37f; margin-top: 8px;">
                <strong>‚ö° Your Efficiency:</strong> ${insights.efficiency_score.toFixed(1)} points per kg CO‚ÇÇ
            </div>`;
        }
    }
    
    return additionalContent;
}

// Show/hide typing indicator
function showTyping() {
    showChatInterface();
    typingIndicator.classList.add('show');
    scrollToBottom();
}

function hideTyping() {
    typingIndicator.classList.remove('show');
}

// Send message
function sendMessage(message) {
    if (!message.trim()) return;
    
    // Add user message
    addMessage(message, 'user');
    
    // Clear input
    chatInput.value = '';
    autoResize();
    
    // Show typing indicator
    showTyping();
    
    // Disable send button
    sendButton.disabled = true;
    sendButton.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="animate-spin">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25"/>
            <path fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" opacity="0.75"/>
        </svg>
    `;
    
    // Send to API
    fetch("{% url 'chatbot-api' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ query: message }),
    })
    .then(response => response.json())
    .then(data => {
        hideTyping();
        addMessage(data.response, 'bot', data.additional_data);
        
        // Re-enable send button
        sendButton.disabled = false;
        sendButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `;
    })
    .catch(error => {
        hideTyping();
        console.error('Chatbot error:', error);
        addMessage("Sorry, I'm having trouble connecting. Please try again! üòÖ", 'bot');
        
        // Re-enable send button
        sendButton.disabled = false;
        sendButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `;
    });
}

// Form submit handler
chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (message && !sendButton.disabled) {
        sendMessage(message);
    }
});

// Enter key handler (Shift+Enter for new line)
chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!sendButton.disabled) {
            chatForm.dispatchEvent(new Event('submit'));
        }
    }
});

// Initial setup
autoResize();
</script>
{% endblock %}